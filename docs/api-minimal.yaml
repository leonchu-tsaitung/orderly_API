openapi: 3.1.0
info:
  title: Orderly API Minimal - 餐廳供應商訂單系統
  description: |
    根據 Issue #30 需求精簡的 API 版本
    
    **供應商功能:**
    - 報價單 CRUD + listing
    - 訂單 detail + listing + modify + confirm
    
    **餐廳功能:**
    - 報價單 listing + detail
    - 訂單 create + modify + detail + listing
    
    **重要業務邏輯:**
    - 下訂單時會自動驗證價格表有效性
    - 訂單中的商品價格必須與當前有效價格表完全一致
    - 所有價格相關操作都基於有效期內的價格表
    - 價格不符將導致訂單建立失敗
  version: 1.0.0-minimal
  contact:
    name: API Support
    email: support@orderly-api.com

servers:
  - url: https://api.orderly.com/v1
    description: 正式環境
  - url: https://staging-api.orderly.com/v1
    description: 測試環境

security:
  - BearerAuth: []

paths:
  # 供應商端 - 報價單管理
  /suppliers/price-lists:
    get:
      summary: 查詢報價單清單
      description: 供應商查詢自己的報價單清單
      tags: [供應商 - 報價單]
      parameters:
        - name: customer_group_code
          in: query
          schema:
            type: string
          description: 篩選特定客群的報價單
        - name: status
          in: query
          schema:
            type: string
            enum: [active, expired]
          description: 篩選報價單狀態
        - name: created_after
          in: query
          schema:
            type: string
            format: date
          description: 篩選指定日期後建立的報價單
      responses:
        '200':
          description: 報價單清單
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PriceListSummary'

    post:
      summary: 建立報價單
      description: 供應商建立新的報價單
      tags: [供應商 - 報價單]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PriceListCreateRequest'
      responses:
        '201':
          description: 報價單建立成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PriceListCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /suppliers/price-lists/{price_list_id}:
    get:
      summary: 查詢報價單詳情
      description: 取得指定報價單的完整資訊
      tags: [供應商 - 報價單]
      parameters:
        - name: price_list_id
          in: path
          required: true
          schema:
            type: string
          description: 報價單ID
      responses:
        '200':
          description: 報價單詳情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PriceList'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: 更新報價單
      description: 供應商更新報價單資訊
      tags: [供應商 - 報價單]
      parameters:
        - name: price_list_id
          in: path
          required: true
          schema:
            type: string
          description: 報價單ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PriceListUpdateRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PriceList'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: 刪除報價單
      description: 供應商刪除報價單
      tags: [供應商 - 報價單]
      parameters:
        - name: price_list_id
          in: path
          required: true
          schema:
            type: string
          description: 報價單ID
      responses:
        '204':
          description: 刪除成功

  # 供應商端 - 訂單管理
  /suppliers/orders:
    get:
      summary: 查詢訂單清單
      description: 供應商查詢收到的訂單清單
      tags: [供應商 - 訂單]
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/OrderStatus'
          description: 篩選訂單狀態
      responses:
        '200':
          description: 訂單清單
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Order'

  /suppliers/orders/{order_id}:
    get:
      summary: 查詢訂單詳情
      description: 供應商查詢指定訂單的完整資訊
      tags: [供應商 - 訂單]
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
          description: 訂單ID
      responses:
        '200':
          description: 訂單詳情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: 修改訂單
      description: 供應商修改訂單資訊
      tags: [供應商 - 訂單]
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
          description: 訂單ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SupplierOrderUpdateRequest'
      responses:
        '200':
          description: 修改成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '404':
          $ref: '#/components/responses/NotFound'

  /suppliers/orders/{order_id}/confirm:
    post:
      summary: 確認訂單
      description: 供應商確認訂單
      tags: [供應商 - 訂單]
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
          description: 訂單ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderConfirmRequest'
      responses:
        '200':
          description: 確認成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '409':
          $ref: '#/components/responses/Conflict'

  # 餐廳端 - 報價單查詢
  /restaurants/price-lists:
    get:
      summary: 查詢報價單清單
      description: 餐廳查詢可用的供應商報價單清單
      tags: [餐廳 - 報價單]
      parameters:
        - name: supplier_id
          in: query
          schema:
            type: string
          description: 篩選特定供應商
      responses:
        '200':
          description: 報價單清單
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PriceListSummary'

  /restaurants/price-lists/{price_list_id}:
    get:
      summary: 查詢報價單詳情
      description: 餐廳查詢指定報價單的完整資訊
      tags: [餐廳 - 報價單]
      parameters:
        - name: price_list_id
          in: path
          required: true
          schema:
            type: string
          description: 報價單ID
      responses:
        '200':
          description: 報價單詳情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PriceList'
        '404':
          $ref: '#/components/responses/NotFound'

  # 餐廳端 - 訂單管理
  /restaurants/orders:
    get:
      summary: 查詢訂單清單
      description: 餐廳查詢自己的訂單清單
      tags: [餐廳 - 訂單]
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/OrderStatus'
          description: 篩選訂單狀態
        - name: supplier_id
          in: query
          schema:
            type: string
          description: 篩選特定供應商
      responses:
        '200':
          description: 訂單清單
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Order'

    post:
      summary: 建立訂單
      description: |
        餐廳建立新訂單
        
        **價格表驗證邏輯:**
        - 系統會自動找到供應商對應客戶群組的有效價格表
        - 驗證價格表是否在有效期內（valid_end_date >= 當前日期）
        - 確認所有訂購商品都存在於價格表中
        - **嚴格價格比對：** 每個商品的 expected_price 必須與價格表中的價格完全一致
        - 如果任何驗證失敗，回傳 422 錯誤並附上詳細錯誤資訊
      tags: [餐廳 - 訂單]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderCreateRequest'
      responses:
        '201':
          description: 訂單建立成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /restaurants/orders/{order_id}:
    get:
      summary: 查詢訂單詳情
      description: 餐廳查詢指定訂單的完整資訊
      tags: [餐廳 - 訂單]
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
          description: 訂單ID
      responses:
        '200':
          description: 訂單詳情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: 修改訂單
      description: 餐廳修改訂單資訊
      tags: [餐廳 - 訂單]
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
          description: 訂單ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RestaurantOrderUpdateRequest'
      responses:
        '200':
          description: 修改成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: 取消訂單
      description: 餐廳取消已建立的訂單
      tags: [餐廳 - 訂單]
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
          description: 訂單ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderCancelRequest'
      responses:
        '200':
          description: 取消成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderCancelResponse'
        '400':
          description: 請求參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 訂單不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: 訂單狀態不允許取消
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      code:
                        type: string
                        example: "INVALID_ORDER_STATUS"
                      message:
                        type: string
                        example: "訂單已確認，無法取消"
                      current_status:
                        type: string
                        description: 目前訂單狀態

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # 基本資料型別
    OrderStatus:
      type: string
      enum: [created, confirmed, completed, cancelled]
      description: |
        訂單狀態
        - created: 已建立
        - confirmed: 已確認
        - completed: 已完成
        - cancelled: 已取消

    # 報價單
    PriceList:
      type: object
      required: [price_list_id, supplier_id, customer_group_code, valid_end_date, price_items]
      properties:
        price_list_id:
          type: string
          description: 報價單ID
        supplier_id:
          type: string
          description: 供應商ID
        customer_group_code:
          type: string
          description: 適用客群代碼
        valid_end_date:
          type: string
          format: date
          description: 有效結束日期
        price_items:
          type: array
          items:
            $ref: '#/components/schemas/PriceItem'
          description: 商品價格清單
        created_at:
          type: string
          format: date-time
          description: 建立時間
        updated_at:
          type: string
          format: date-time
          description: 更新時間

    PriceItem:
      type: object
      required: [item_code, item_name, price, unit]
      properties:
        item_code:
          type: string
          description: 商品代碼
        item_name:
          type: string
          description: 商品名稱
        price:
          type: number
          format: float
          minimum: 0
          description: 商品價格
        unit:
          type: string
          description: 計價單位

    PriceListCreateRequest:
      type: object
      required: [customer_group_code, valid_end_date, price_items]
      properties:
        customer_group_code:
          type: string
          description: 適用客群代碼
        valid_end_date:
          type: string
          format: date
          description: 有效結束日期
        price_items:
          type: array
          items:
            $ref: '#/components/schemas/PriceItem'
          description: 商品價格清單
          minItems: 1

    PriceListUpdateRequest:
      type: object
      properties:
        customer_group_code:
          type: string
          description: 適用客群代碼
        valid_end_date:
          type: string
          format: date
          description: 有效結束日期
        price_items:
          type: array
          items:
            $ref: '#/components/schemas/PriceItem'
          description: 商品價格清單

    PriceListSummary:
      type: object
      required: [price_list_id, supplier_id, customer_group_code, valid_end_date]
      properties:
        price_list_id:
          type: string
          description: 報價單ID
        supplier_id:
          type: string
          description: 供應商ID
        customer_group_code:
          type: string
          description: 適用客群代碼
        valid_end_date:
          type: string
          format: date
          description: 有效結束日期
        item_count:
          type: integer
          description: 包含的商品數量
        created_at:
          type: string
          format: date-time
          description: 建立時間
        updated_at:
          type: string
          format: date-time
          description: 更新時間

    PriceListCreateResponse:
      type: object
      required: [price_list_id, message]
      properties:
        price_list_id:
          type: string
          description: 新建立的報價單ID
        message:
          type: string
          description: 成功訊息
        success_count:
          type: integer
          description: 成功建立的商品數量
        failed_items:
          type: array
          items:
            type: object
            properties:
              item_code:
                type: string
                description: 商品代碼
              error:
                type: string
                description: 錯誤訊息
          description: 失敗的商品及錯誤訊息


    # 訂單
    Order:
      type: object
      required: [order_id, restaurant_id, supplier_id, order_date, delivery_date, order_status, order_items, order_total]
      properties:
        order_id:
          type: string
          description: 訂單ID
        restaurant_id:
          type: string
          description: 餐廳ID
        supplier_id:
          type: string
          description: 供應商ID
        order_date:
          type: string
          format: date-time
          description: 下訂時間
        delivery_date:
          type: string
          format: date
          description: 交貨日期
        order_status:
          $ref: '#/components/schemas/OrderStatus'
        order_items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
          description: 訂單商品清單
        order_total:
          type: number
          format: float
          minimum: 0
          description: 訂單總額
        created_at:
          type: string
          format: date-time
          description: 建立時間
        updated_at:
          type: string
          format: date-time
          description: 更新時間

    OrderItem:
      type: object
      required: [item_code, item_name, quantity, price, unit]
      properties:
        item_code:
          type: string
          description: 商品代碼
        item_name:
          type: string
          description: 商品名稱
        quantity:
          type: number
          format: float
          minimum: 0
          description: 訂購數量
        price:
          type: number
          format: float
          minimum: 0
          description: 商品單價
        unit:
          type: string
          description: 計價單位
        subtotal:
          type: number
          format: float
          minimum: 0
          description: 小計金額

    OrderCreateRequest:
      type: object
      required: [supplier_id, delivery_date, order_items]
      properties:
        supplier_id:
          type: string
          description: 供應商ID
        delivery_date:
          type: string
          format: date
          description: 希望交貨日期
        order_items:
          type: array
          items:
            type: object
            required: [item_code, quantity, expected_price]
            properties:
              item_code:
                type: string
                description: |
                  商品代碼
                  
                  **注意：** 系統會驗證此商品代碼是否存在於供應商的有效價格表中
              quantity:
                type: number
                format: float
                minimum: 0
                description: 訂購數量
              expected_price:
                type: number
                format: float
                minimum: 0
                description: |
                  預期單價
                  
                  **重要：** 此價格必須與當前有效價格表中的價格完全一致，否則訂單將被拒絕
          description: |
            訂購商品清單
            
            **價格表驗證說明：**
            - 系統會自動找到供應商對應客戶群組的有效價格表
            - 驗證價格表是否在有效期內（valid_end_date >= 當前日期）
            - 確認所有 item_code 都存在於價格表中
            - **價格比對驗證：** 每個商品的 expected_price 必須與價格表中的價格完全一致
            - 如任何驗證失敗，將回傳 422 錯誤
          minItems: 1

    SupplierOrderUpdateRequest:
      type: object
      properties:
        delivery_date:
          type: string
          format: date
          description: 交貨日期
        order_items:
          type: array
          items:
            type: object
            properties:
              item_code:
                type: string
                description: 商品代碼
              quantity:
                type: number
                format: float
                minimum: 0
                description: 數量
              price:
                type: number
                format: float
                minimum: 0
                description: 價格
          description: 訂單商品清單

    RestaurantOrderUpdateRequest:
      type: object
      properties:
        delivery_date:
          type: string
          format: date
          description: 希望交貨日期
        order_items:
          type: array
          items:
            type: object
            required: [item_code, quantity]
            properties:
              item_code:
                type: string
                description: 商品代碼
              quantity:
                type: number
                format: float
                minimum: 0
                description: 訂購數量
          description: 訂購商品清單

    OrderConfirmRequest:
      type: object
      required: [confirmed_items]
      properties:
        confirmed_items:
          type: array
          items:
            type: object
            required: [item_code, confirmed_price, confirmed_quantity]
            properties:
              item_code:
                type: string
                description: 商品代碼
              confirmed_price:
                type: number
                format: float
                minimum: 0
                description: 確認價格
              confirmed_quantity:
                type: number
                format: float
                minimum: 0
                description: 確認數量
          description: 確認商品清單
          minItems: 1

    OrderCancelRequest:
      type: object
      required: [reason_code, reason_text]
      properties:
        reason_code:
          type: string
          enum: [customer_change_mind, wrong_order, supplier_issue, other]
          description: |
            取消原因分類
            - customer_change_mind: 客戶改變主意
            - wrong_order: 下錯訂單
            - supplier_issue: 供應商問題
            - other: 其他原因
        reason_text:
          type: string
          description: 取消原因詳細說明
          minLength: 1
          maxLength: 500

    OrderCancelResponse:
      type: object
      required: [message, cancelled_at, order_id]
      properties:
        message:
          type: string
          description: 成功訊息
          example: "訂單已成功取消"
        cancelled_at:
          type: string
          format: date-time
          description: 取消時間
        order_id:
          type: string
          description: 已取消的訂單ID
        previous_status:
          type: string
          description: 取消前的訂單狀態


    # 共用元件

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: 錯誤代碼
            message:
              type: string
              description: 錯誤訊息
            details:
              type: string
              description: 詳細說明

  responses:
    BadRequest:
      description: 請求格式錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "INVALID_REQUEST"
              message: "請求格式錯誤"
              details: "必填欄位缺失或格式不正確"

    Unauthorized:
      description: 未認證
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: 資源不存在
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Conflict:
      description: 業務邏輯衝突
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    UnprocessableEntity:
      description: 價格表驗證失敗
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            price_list_expired:
              summary: 價格表已過期
              value:
                error:
                  code: "PRICE_LIST_EXPIRED"
                  message: "價格表已過期"
                  details: "供應商的價格表已於指定日期過期，請聯絡供應商更新價格表"
            item_not_found:
              summary: 商品不存在於價格表
              value:
                error:
                  code: "ITEM_NOT_FOUND"
                  message: "商品不存在"
                  details: "指定的商品代碼不存在於當前有效的價格表中"
            no_valid_price_list:
              summary: 無可用價格表
              value:
                error:
                  code: "NO_VALID_PRICE_LIST"
                  message: "無可用的價格表"
                  details: "供應商目前沒有適用於您客戶群組的有效價格表"
            price_mismatch:
              summary: 價格不符
              value:
                error:
                  code: "PRICE_MISMATCH"
                  message: "商品價格不符"
                  details: "商品 ITEM001 的預期價格 $100.00 與價格表中的價格 $120.00 不符"
            multiple_price_errors:
              summary: 多項價格錯誤
              value:
                error:
                  code: "MULTIPLE_PRICE_ERRORS"
                  message: "多項商品價格驗證失敗"
                  details: "發現 3 項商品的價格與價格表不符，請檢查並修正後重新提交"
                  invalid_items:
                    - item_code: "ITEM001"
                      expected_price: 100.00
                      actual_price: 120.00
                    - item_code: "ITEM002"
                      expected_price: 50.00
                      actual_price: 55.00

tags:
  - name: 供應商 - 報價單
    description: 供應商報價單管理功能
  - name: 供應商 - 訂單
    description: 供應商訂單管理功能
  - name: 餐廳 - 報價單
    description: 餐廳報價單查詢功能
  - name: 餐廳 - 訂單
    description: 餐廳訂單管理功能