# API 架構規劃草稿

## 資料定義

### 價格表

- 一個供應商會上傳多個價格表
- 一個價格表包含適用客群代碼、有效時間區間、價格表版本代碼、一個清單包含多個價格元素

### 價格元素

- 包含品項代碼、品項名稱、品項說明(選填)、供應狀態、價格類型、價格、計價單位、是否應稅
- 價格類型分為「固定價格」與「時價」
- 固定價格：直接顯示確定金額
- 時價：報價階段顯示「時價」標示，可選填預估價格區間，實際價格於訂單確認階段由供應商確定

### 訂單

- 一個餐廳可對每個有取得有效價格表的供應商下訂單
- 一個訂單包含下訂時間、交貨日期、本次特殊到貨時間（選填）、對應的價格表版本代碼、收貨單位、本次特殊收貨地點（選填）、一個清單包含多個需求元素、訂單狀態、運費、菜價折抵(含稅)、菜價折抵(不含稅)、運費折抵、其他折抵（結構化，可拓展多種項目）、訂單總額

### 需求元素

- 包含品項代碼、品項名稱、訂購數量、價格、計價單位
- 價格除了直接價錢外，針對時價項目可選擇指定成交金額範圍

### 異動記錄

- 包含記錄ID、關聯訂單、操作類型、操作時間、操作人、異動前後值、原因說明
- 原因碼結構：類別代碼 + 具體原因 + 自定義文字說明
- 預設類別：品質相關、數量相關、客戶相關、供應商相關
- 記錄時機：理貨更新時、驗收時發現差異、事後訂單異動時

### 理貨更新與訂單異動邊界定義

- **理貨更新**（訂單確認到出貨階段）
  - 僅能修改：實際出貨數量
  - 適用時機：供應商進行揀貨、打包時的數量調整
  - 限制：不能修改品項、價格
- **訂單異動**（驗收完畢後）
  - 可以修改：實際出貨品項、實際出貨數量、直接價格
  - 適用時機：雙方協商後的事後調整
  - 要求：每次異動都需填寫原因說明

### 訂單狀態

- 正流程依序為
    - 建立
    - 確認
    - 出貨（可跳過）
    - 到貨（可跳過）
    - 驗收完畢
    - 結帳
- 另有特殊狀態
    - 作廢
    - 退回

### 訂單狀態轉換規則

- 建立 → 確認：供應商執行，餐廳無法修改
- 確認 → 出貨：供應商執行，可跳過直接到「到貨」或「驗收完畢」
- 出貨 → 到貨：供應商執行或系統自動，可跳過直接到「驗收完畢」
- 到貨 → 驗收完畢：透過驗收APP執行
- 驗收完畢 → 結帳：供應商執行
- 退回機制：僅在「驗收完畢」之前可退回到「建立」狀態，退回後餐廳可重新修改
- 作廢條件：僅餐廳可執行，且僅限「建立」狀態時

## 動作定義

### 供應商端

- 價格表
    - CRUD，都以整份價格表為單位
    - 查詢價格表歷史版本清單：依時間順序列出指定價格表的所有版本
    - 查詢指定版本詳細內容：查看歷史版本的完整價格表資料
- 訂單
    - 查詢訂單清單：支援依日期範圍、訂單狀態、客戶篩選
    - 查詢單一訂單詳情
    - 單對單一訂單的狀態更新，一旦往下個階段就不能執行前一階段指令
        - 訂單確認，此時須將時價品項進行定價、設定運費，並可修改實際出貨量
            - 只能執行一次
        - 訂單出貨，可再次修改實際出貨量
            - 只能執行一次
        - 訂單到貨，不可修改資訊
    - 訂單驗收之前，接可使訂單退回
        - 訂單退回狀態可執行的行為同「建立」
    - 在訂單確認到訂單出貨之間，可進行多次「理貨更新」，每次皆可更新實際出貨量
    - 訂單驗收後可進行多次「訂單異動」，每次皆可更新實際出貨品項、實際出貨量、直接價格
    - 查詢單一訂單更新歷程

### 餐廳端

- 價格表
    - 查詢清單、查詢詳情，都以整份價格表為單位
    - 查詢價格表歷史版本清單：查看可取得之價格表的版本記錄
    - 查詢指定版本詳細內容：查看歷史版本的完整價格表資料
- 訂單
    - 查詢訂單清單：支援依日期範圍、訂單狀態、供應商篩選
    - 查詢單一訂單詳情
    - 建立訂單
    - 在訂單確認之前，可進行多次「修改訂單」，每次皆可更新需求品項、需求量
    - 在訂單確認之前，可將訂單作廢，作廢後的訂單無法進行任何更新
    - 查詢單一訂單更新歷程

### 其他

- 會有一個訂單驗收的 APP，由餐廳操作，可使訂單進入驗收完畢狀態
    - 過程會更改實際出貨量
    - 同一筆訂單不能重複驗收

### 通知機制

- 通知時機：訂單狀態變更、價格表更新、緊急異動
- 通知方式：webhook 推送（接收方需提供 webhook URL 註冊）
- 通知內容：事件類型、訂單編號、狀態變更時間、關鍵異動資訊
	
